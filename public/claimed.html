<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Status</title>
    <style>
    :root{
            --holo-1: #7fffd4;
            --holo-2: #00b4ff;
            --holo-3: #ff6ec7;
            --bg: #0f1720;
            --success-green: #00c853;
            --error-red: #ff1744;
    }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: linear-gradient(180deg,#061017 0%, #091420 100%); color: #fff; display: flex; align-items: center; justify-content: center; }
        .card { width:min(980px,94vw); padding: 2rem; border-radius: 14px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(2,6,23,0.6); text-align: center; }
        .status-area { display:flex; gap:2rem; align-items:center; justify-content:center; flex-direction:column; }

        /* Large holographic icon */
        .holo-wrap { width: 380px; height: 380px; position: relative; display: grid; place-items: center; margin: 0 auto; }
        svg.holo { width: 80%; height: 80%; filter: drop-shadow(0 8px 30px rgba(0,0,0,0.6)); transform-origin:center; animation: float 5s ease-in-out infinite; }

        @keyframes float{ 0%{transform:translateY(0) rotate(-2deg)} 50%{transform:translateY(-6px) rotate(2deg)} 100%{transform:translateY(0) rotate(-2deg)} }

        /* moving holographic gradient */
        .holo-gradient{ position:absolute; inset:0; border-radius:20px; pointer-events:none; mix-blend-mode:screen; background:linear-gradient(120deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); overflow:hidden; }
        .holo-gradient::before{ content:""; position:absolute; inset:-40% -40% ; background: conic-gradient(from 180deg at 50% 50%, var(--holo-1), var(--holo-2), var(--holo-3), var(--holo-1)); filter: blur(28px); transform: rotate(0deg); animation: spin 6s linear infinite; opacity:0.9 }

        @keyframes spin{ to{ transform: rotate(360deg); } }

        /* animated shine sweep */
        .shine{ position:absolute; inset:0; border-radius:20px; overflow:hidden; }
        .shine::after{ content:""; position:absolute; left:-40%; top:-50%; width:60%; height:200%; background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.22) 50%, rgba(255,255,255,0.0) 100%); transform: rotate(-20deg); animation: sweep 2.2s ease-in-out infinite; mix-blend-mode:overlay }
        @keyframes sweep{ 0%{left:-60%} 50%{left:60%} 100%{left:120%} }

        /* subtle noise overlay to break screenshots */
        .noise { position:absolute; inset:0; background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02), transparent 12%), radial-gradient(circle at 80% 70%, rgba(255,255,255,0.015), transparent 8%); mix-blend-mode:overlay; opacity:0.85; pointer-events:none; }

        h1 { margin: 0 0 8px 0; font-size: clamp(20px, 3.2vw, 34px); letter-spacing:0.4px }
        p.lead { margin:0; opacity:0.9 }

        .reason { margin-top: 1rem; color: #dbeafe; max-width: 820px; }

        .success-border { border: 2px solid rgba(0,200,140,0.12); }
        .error-border   { border: 2px solid rgba(255,50,90,0.12); }

        /* big status text and rotating nonce to prevent screenshots being valid */
        .nonce { margin-top: 1rem; font-weight:600; letter-spacing:2px; color: #fff; opacity:0.9; font-size: 18px }

        .status-small { margin-top: 12px; font-size: 15px; color: #d1d5db }

    /* tick/cross color adjustments: paths use currentColor so parent class controls color */
    svg.ok { color: var(--success-green); }
    svg.err { color: var(--error-red); }
    /* ensure accent paths use currentColor */
    .accent { stroke: currentColor; }

        /* responsive */
        @media (min-width:800px){ .status-area{flex-direction:row} }
    </style>
</head>
<body>
    <div class="card">
        <div id="status-container" class="status-area">
            <div id="holo" class="holo-wrap success-border">
                <!-- SVG icon: we'll toggle classes ok/err to change colors and paths -->
                <svg id="status-icon" class="holo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <defs>
                        <linearGradient id="g1" x1="0%" x2="100%" y1="0%" y2="100%">
                            <stop offset="0%" stop-color="#fff" stop-opacity="0.9" />
                            <stop offset="50%" stop-color="#fff" stop-opacity="0.1" />
                            <stop offset="100%" stop-color="#fff" stop-opacity="0.9" />
                        </linearGradient>
                    </defs>
                    <g id="ok-group" style="opacity:0; transition:opacity .22s ease-in-out">
                        <circle cx="60" cy="60" r="54" fill="rgba(255,255,255,0.02)" stroke="url(#g1)" stroke-width="1" />
                            <path class="accent" d="M36 63 L52 78 L84 44" fill="none" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"/>
                    </g>
                    <g id="err-group" style="opacity:0; transition:opacity .22s ease-in-out">
                        <circle cx="60" cy="60" r="54" fill="rgba(255,255,255,0.02)" stroke="url(#g1)" stroke-width="1" />
                            <path class="accent" d="M40 40 L80 80 M80 40 L40 80" fill="none" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor"/>
                    </g>
                </svg>
                <div class="holo-gradient"></div>
                <div class="shine"></div>
                <div class="noise"></div>
            </div>

            <div style="max-width:520px; text-align:left">
                <h1 id="status-heading">Checking…</h1>
                <p class="lead" id="status-message">Please wait while we verify the claim status.</p>
                <p class="reason" id="status-reason"></p>
                <div id="nonce" class="nonce" aria-hidden="true">Holo-ID: ----</div>
                <div class="status-small" id="tips">Show this animated screen to the event staff. Screenshots may be rejected.</div>
            </div>
        </div>
    </div>

    <script>
        // Small helper to create a short animated nonce to make screenshots time-sensitive
        function makeNonce(){
            const a = Math.random().toString(36).slice(2,8).toUpperCase();
            const b = (Date.now() % 1000).toString().padStart(3,'0');
            return a + '-' + b;
        }

        let nonceEl;
        let nonceTimer;

        window.onload = function(){
            console.log('claimed.html loaded, searchParams=', window.location.search);
            const params = new URLSearchParams(window.location.search);
            const status = params.get('status');
            const container = document.getElementById('holo');
            const heading = document.getElementById('status-heading');
            const message = document.getElementById('status-message');
                const reason = document.getElementById('status-reason');
            nonceEl = document.getElementById('nonce');
            // If the nonce element is unexpectedly missing, create it so script continues
            if(!nonceEl){
                nonceEl = document.createElement('div');
                nonceEl.id = 'nonce';
                nonceEl.className = 'nonce';
                document.getElementById('status-reason').insertAdjacentElement('afterend', nonceEl);
            }
            const urlParams = new URLSearchParams(window.location.search);
            const serverToken = urlParams.get('token');
            const serverExpires = urlParams.get('expiresAt');
            const tokenDisplay = document.createElement('div');
            tokenDisplay.style.marginTop = '10px';
            tokenDisplay.style.fontFamily = 'monospace';
            tokenDisplay.style.fontSize = '18px';
            tokenDisplay.style.letterSpacing = '2px';
            tokenDisplay.id = 'server-token';
            tokenDisplay.textContent = serverToken ? `Token: ${serverToken}` : '';
            document.getElementById('status-reason').insertAdjacentElement('afterend', tokenDisplay);
            const countdown = document.createElement('div');
            countdown.id = 'token-countdown';
            countdown.style.marginTop = '6px';
            countdown.style.fontSize = '13px';
            countdown.style.opacity = '0.9';
            tokenDisplay.insertAdjacentElement('afterend', countdown);
            const okGroup = document.getElementById('ok-group');
            const errGroup = document.getElementById('err-group');
            const svg = document.getElementById('status-icon');

            // default
            heading.textContent = 'Unknown Status';
            message.textContent = 'An unknown error occurred. Please try again.';
            reason.textContent = '';

            function setSuccess(){
                console.log('setSuccess() called');
                okGroup.style.opacity = '1';
                errGroup.style.opacity = '0';
                container.classList.remove('error-border');
                container.classList.add('success-border');
                svg.classList.remove('err'); svg.classList.add('ok');
                // explicitly set stroke color on the accent path (some browsers don't inherit svg color reliably)
                try{
                    const accent = okGroup.querySelectorAll('.accent');
                    const root = getComputedStyle(document.documentElement);
                    const c = root.getPropertyValue('--success-green').trim() || '#00c853';
                    // force stroke on all accent paths as a robust fallback
                    accent.forEach(a => { if(a) a.style.stroke = c; });
                    // also ensure the main svg color is set
                    svg.style.color = c;
                    // small pop animation
                    okGroup.animate([{ transform: 'scale(.96)' }, { transform: 'scale(1)' }], { duration: 300, easing: 'cubic-bezier(.2,.9,.2,1)'});
                    console.log('claimed UI: setSuccess applied, stroke=', c);
                }catch(e){/* ignore */}
            }

            function setError(){
                console.log('setError() called');
                okGroup.style.opacity = '0';
                errGroup.style.opacity = '1';
                container.classList.remove('success-border');
                container.classList.add('error-border');
                svg.classList.remove('ok'); svg.classList.add('err');
                try{
                    const accent = errGroup.querySelectorAll('.accent');
                    const root = getComputedStyle(document.documentElement);
                    const c = root.getPropertyValue('--error-red').trim() || '#ff1744';
                    accent.forEach(a => { if(a) a.style.stroke = c; });
                    svg.style.color = c;
                    errGroup.animate([{ transform: 'scale(.96)' }, { transform: 'scale(1)' }], { duration: 300, easing: 'cubic-bezier(.2,.9,.2,1)'});
                    console.log('claimed UI: setError applied, stroke=', c);
                }catch(e){/* ignore */}
            }

            switch(status){
                case 'success':
                    setSuccess();
                    heading.textContent = 'Claim Approved';
                    message.textContent = 'Your jersey has been claimed successfully.';
                    reason.textContent = 'Bring this animated screen to the collection desk. We verify both your identity and the live holographic ID.';
                    break;
                case 'already_claimed':
                    setError();
                    heading.textContent = 'Already Claimed';
                    message.textContent = 'This email has already been used to claim a jersey.';
                    reason.textContent = 'If you believe this is an error, contact event staff with your ID. Screenshots will be rejected — this page is intentionally animated.';
                    break;
                case 'locked_device':
                    setError();
                    heading.textContent = 'Device Locked';
                    message.textContent = 'This device has already been used to claim a jersey with a different account.';
                    reason.textContent = 'If this is your device and you believe this is an error, contact event staff and provide your college ID. Clearing cookies or using a different browser will bypass this protection.';
                    break;
                case 'invalid_email':
                    setError();
                    heading.textContent = 'Invalid Email';
                    message.textContent = 'Please use your official RVU email address to claim your jersey.';
                    reason.textContent = 'Only accounts with the official institution email can claim a jersey. If you used a different account, sign in with your RVU account.';
                    break;
                default:
                    setError();
                    heading.textContent = 'Unknown / Error';
                    message.textContent = 'An error occurred while verifying your claim.';
                    reason.textContent = 'Try again or ask event staff for assistance.';
            }

            // animate nonce more frequently when status is success to make screenshots less useful
            function startNonce(fast){
                if(nonceTimer) clearInterval(nonceTimer);
                nonceEl.textContent = 'Holo-ID: ' + makeNonce();
                nonceTimer = setInterval(()=>{ nonceEl.textContent = 'Holo-ID: ' + makeNonce(); }, fast?600:1200);
            }

            startNonce(status === 'success');

            // Show server token countdown if provided
            if(serverToken){
                let expiresAt = serverExpires ? new Date(serverExpires) : null;
                // If expires_at not provided via query, fetch token expiry from server (optional)
                if(!expiresAt){
                    // best-effort: attempt to query server for token expiry (no auth required)
                    fetch(`/token-info?token=${encodeURIComponent(serverToken)}`).then(r=>r.json()).then(j=>{
                        if(j && j.expiresAt) expiresAt = new Date(j.expiresAt);
                        startCountdown();
                    }).catch(()=> startCountdown());
                } else startCountdown();

                function startCountdown(){
                    if(!expiresAt){ countdown.textContent = 'Expires: soon'; return; }
                    function tick(){
                        const ms = expiresAt - new Date();
                        if(ms <= 0){ countdown.textContent = 'Token expired'; return; }
                        const s = Math.floor(ms/1000);
                        countdown.textContent = `Token expires in ${s}s`;
                    }
                    tick();
                    setInterval(tick, 800);
                }
            }

            // Also change the page title briefly to show live activity (makes static screenshots less likely)
            let titleBase = document.title;
            let blink = 0;
            setInterval(()=>{ document.title = (blink++%2===0? '✔︎ '+ heading.textContent : '✦ '+ heading.textContent); }, 900);
        };
    </script>
</body>
</html>